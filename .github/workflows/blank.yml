name: MASM Build → BIN (VS2022)

on:
  push:
    paths:
      - '**/*.asm'
      - 'includes/**'
  pull_request:
    paths:
      - '**/*.asm'
      - 'includes/**'

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Install VS2022 Build Tools
        uses: microsoft/visualstudio-setup-action@v1
        with:
          version: '2022'
          components: 'VC.Tools.x86.x64'

      - name: Set MASM path
        run: |
          setx PATH "%PATH%;C:\Program Files\Microsoft Visual Studio\2022\BuildTools\VC\Tools\MSVC\*\bin\Hostx64\x64"

      - name: Create build folder
        run: mkdir build

      - name: Assemble ASM files to BIN
        run: |
          $BUILD_DIR = "$(pwd)/build"
          mkdir -p "$BUILD_DIR"

          for f in $(dir /b *.asm); do
            filename=$(basename "$f" .asm)
            echo "Processing $f → $filename.bin"

            # Detect mode by comment ;MODE=16 or ;MODE=32
            SET MODE=32
            findstr /C:";MODE=16" "$f" >nul && SET MODE=16

            if "%MODE%"=="16" (
                echo "Assembling 16-bit $f"
                ml /c /coff "$f" /Fo"$BUILD_DIR\$filename.obj" /I includes
                link /TINY /ENTRY:start "$BUILD_DIR\$filename.obj" /OUT:"$BUILD_DIR\$filename.exe"
            ) else (
                echo "Assembling 32-bit $f"
                ml /c /coff "$f" /Fo"$BUILD_DIR\$filename.obj" /I includes
                link /SUBSYSTEM:NATIVE /ENTRY:main "$BUILD_DIR\$filename.obj" /OUT:"$BUILD_DIR\$filename.exe"
            )

            REM Convert .exe to raw binary
            copy /b "$BUILD_DIR\$filename.exe" "$BUILD_DIR\$filename.bin"
          done

